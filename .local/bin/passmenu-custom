#!/usr/bin/env bash

shopt -s nullglob globstar lastpipe

typeit=0
if [[ $1 == "--type" ]]; then
	typeit=1
	shift
fi

if [[ -n $WAYLAND_DISPLAY ]]; then
	#dmenu=dmenu-wl
	#dmenu='tofi'
	dmenu='wofi --dmenu --sort-order=alphabetical'
	#xdotool="ydotool type --file -"
	xdotool="wtype -"
	hitenter="ydotool key ENTER" ###
	otpdisplay="wl-paste"
elif [[ -n $DISPLAY ]]; then
	dmenu=dmenu

	# xdotool became really slow after an update, setting
    # --delay to 0 helps but it's still not nearly
    # as fast as before.
    
    # Downgrading seems to have fixed this.

	#xdotool="xdotool type --clearmodifiers --file -"
	xdotool="xdotool type --clearmodifiers --delay 0 --file -"

	hitenter="xdotool key ENTER" ###
	otpdisplay="xclip -selection clipboard -o"
else
	echo "Error: No Wayland or X11 display detected" >&2
	exit 1
fi

prefix=${PASSWORD_STORE_DIR-~/.password-store}
password_files=( "$prefix"/**/*.gpg )
password_files=( "${password_files[@]#"$prefix"/}" )
password_files=( "${password_files[@]%.gpg}" )

password=$(printf '%s\n' "${password_files[@]}" | $dmenu "$@")

[[ -n $password ]] || exit

if [[ $typeit -eq 0 ]]; then
	pass show -c "$password" 2>/dev/null
else
	# pass show "$password" | { IFS= read -r pass; IFS= read -r otpuri; printf %s "$pass"; } | $xdotool #&& $hitenter

    # { IFS= read -r pass ; IFS= read -r otpuri } < <(pass show tec)
    #printf %s "$pass" | $xdotool
    # unset pass

    # { IFS= read -r ; printf %s "$REPLY" ; IFS= read -r user } < <(pass show "$password") | $xdotool

    # Logic to limit scope of password, detect
    # if an OTP URI exists and if it does,
    # invoke the handler. This assumes a
    # password structure where the first line
    # is the password and the second is the URI.
    pass show "$password" | 
        {
            IFS= read -r pass
            IFS= read -r otpuri

            printf %s "$pass" | $xdotool

            # OTPs
            [ -n "$otpuri" ] && pass otp $password -c && notify-send -a "dwm" "OTP" "OTP code copied to clipboard: $($otpdisplay)"
        }
fi

